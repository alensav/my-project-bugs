#!/bin/bash

BUGS_DIR="/home/alensav/my-project-git/bugs"
SERVER_IP="192.168.1.75"
SERVER_URL="http://$SERVER_IP:8001"

get_next_id() {
    local max_id=0
    for f in "$BUGS_DIR"/*.md; do
        if [[ -f "$f" ]]; then
            id_str=$(basename "$f" | cut -d'-' -f1)
            if [[ "$id_str" =~ ^[0-9]+$ ]]; then
                id_num=$(echo "$id_str" | sed 's/^0*//')
                id_num=${id_num:-0}
                if (( id_num > max_id )); then
                    max_id=$id_num
                fi
            fi
        fi
    done
    echo $((max_id + 1))
}

case "$1" in
    create)
        if [ -z "$2" ]; then
            echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 create \"–û–ø–∏—Å–∞–Ω–∏–µ –±–∞–≥–∞\""
            exit 1
        fi

        mkdir -p "$BUGS_DIR"
        BUG_ID=$(get_next_id)
        PADDED_ID=$(printf "%03d" $BUG_ID)
        SAFE_TITLE=$(echo "$2" | tr ' /' '-' | sed 's/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å-]/_/g; s/--*/-/g; s/-$//; s/^-//')
        FILENAME="$BUGS_DIR/${PADDED_ID}-${SAFE_TITLE}.md"

        cat > "$FILENAME" << END
# –ë–∞–≥ #${PADDED_ID}: $2

**–°—Ç–∞—Ç—É—Å:** ‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç
**–ê–≤—Ç–æ—Ä:** alensav
**–î–∞—Ç–∞:** $(date +'%d.%m.%Y %H:%M')

## –û–ø–∏—Å–∞–Ω–∏–µ
–ë–∞–≥ —Å–æ–∑–¥–∞–Ω –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.

## –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

END

        echo "‚úÖ –ë–∞–≥ —Å–æ–∑–¥–∞–Ω: $(basename "$FILENAME")"

        # === TELEGRAM ===
        TELEGRAM_BOT_TOKEN="8364800671:AAE7YazwQE0oEJ6RyGhwg30ZDqF9967L9tk"
        TELEGRAM_CHAT_ID="115815272"
        curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=üÜï –ë–∞–≥ $PADDED_ID: $2" >/dev/null
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        cd /home/alensav/my-project-git || exit 1
        ./bug-tracker sync
        ;;

    list)
        echo "üìã –ë–ê–ì–ò:"
        shopt -s nullglob
        files=("$BUGS_DIR"/*.md)
        if [ ${#files[@]} -eq 0 ]; then
            echo "–ù–µ—Ç –±–∞–≥–æ–≤"
        else
            for file in "${files[@]}"; do
                ID=$(basename "$file" | cut -d'-' -f1)
                TITLE=$(head -n1 "$file" | sed 's/^# –ë–∞–≥ #[0-9]*: //')
                echo -e "${ID}:\t${TITLE}"
            done | sort -n
        fi
        ;;

    sync)
        echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Orange PI..."
        if ! rsync -av --delete "$BUGS_DIR"/ "orangepi@$SERVER_IP:/home/orangepi/my-project/bugs/"; then
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH-–¥–æ—Å—Ç—É–ø."
            exit 1
        fi
        echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

        # === GITHUB ===
        echo "‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ GitHub..."
        cd /home/alensav/my-project-git || exit 1
        git add bugs/
        if ! git diff --quiet --cached; then
            git commit -m "Sync: $(date +'%Y-%m-%d %H:%M')"
            git push origin master
            echo "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ GitHub"
        else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏"
        fi
        ;;

    server-status)
        echo "üìä –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´:"
        echo "================="
        if timeout 3 curl -s "$SERVER_URL/api/bugs" >/dev/null; then
            echo "üåê –°–µ—Ä–≤–µ—Ä: ‚úÖ –î–û–°–¢–£–ü–ï–ù"
            bugs_count=$(curl -s "$SERVER_URL/api/bugs" | python3 -c "import json,sys; print(json.load(sys.stdin)['count'])")
            echo "üìÅ –ë–∞–≥–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: $bugs_count"
            echo "üì± –ú–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $SERVER_URL/mobile"
        else
            echo "üåê –°–µ—Ä–≤–µ—Ä: ‚ùå –ù–ï–î–û–°–¢–£–ü–ï–ù"
            echo "üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ssh orangepi@$SERVER_IP 'sudo systemctl status bug-server'"
        fi
        ;;

    web)
        echo "üåê –û—Ç–∫—Ä—ã–≤–∞—é –º–æ–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é..."
        if command -v xdg-open >/dev/null; then
            xdg-open "$SERVER_URL/mobile"
        else
            echo "–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: $SERVER_URL/mobile"
        fi
        ;;

    *)
        echo "üêõ –°–ò–°–¢–ï–ú–ê –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø –ë–ê–ì–û–í"
        echo "--------------------------------"
        echo "–ö–æ–º–∞–Ω–¥—ã:"
        echo "  $0 create \"–û–ø–∏—Å–∞–Ω–∏–µ\"    ‚Äî –°–æ–∑–¥–∞—Ç—å –±–∞–≥"
        echo "  $0 list                  ‚Äî –°–ø–∏—Å–æ–∫ –±–∞–≥–æ–≤"
        echo "  $0 sync                  ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ GitHub"
        echo "  $0 server-status         ‚Äî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä"
        echo "  $0 web                   ‚Äî –û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
        ;;
esac
