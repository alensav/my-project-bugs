#!/bin/bash

BUGS_DIR="/home/alensav/my-project-git/bugs"
get_next_id() {
    local max_id=0
    for f in "$BUGS_DIR"/*.md; do
        if [[ -f "$f" ]]; then
            id_str=$(basename "$f" | cut -d'-' -f1)
            if [[ "$id_str" =~ ^[0-9]+$ ]]; then
                # –£–¥–∞–ª—è–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏: 008 ‚Üí 8
                id_num=$(echo "$id_str" | sed 's/^0*//')
                # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π (–±—ã–ª–æ "000"), —Å—Ç–∞–≤–∏–º 0
                id_num=${id_num:-0}
                if (( id_num > max_id )); then
                    max_id=$id_num
                fi
            fi
        fi
    done
    echo $((max_id + 1))
}
case "$1" in
    create)
        if [ -z "$2" ]; then
            echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 create \"–û–ø–∏—Å–∞–Ω–∏–µ\""
            exit 1
        fi
        mkdir -p "$BUGS_DIR"
        BUG_ID=$(get_next_id)
        PADDED_ID=$(printf "%03d" $BUG_ID)
        SAFE_TITLE=$(echo "$2" | tr ' /' '-' | sed 's/[^a-zA-Z0-9–∞-—è–ê-–Ø—ë–Å-]/_/g; s/--*/-/g; s/-$//; s/^-//')
        FILENAME="$BUGS_DIR/${PADDED_ID}-${SAFE_TITLE}.md"
        echo "# –ë–∞–≥ #${PADDED_ID}: $2

**–°—Ç–∞—Ç—É—Å:** ‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç
**–ê–≤—Ç–æ—Ä:** alensav
**–î–∞—Ç–∞:** $(date +'%d.%m.%Y %H:%M')

## –û–ø–∏—Å–∞–Ω–∏–µ
–ë–∞–≥ —Å–æ–∑–¥–∞–Ω –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.

## –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
" > "$FILENAME"
        echo "‚úÖ –ë–∞–≥ —Å–æ–∑–¥–∞–Ω: $(basename "$FILENAME")"
        # === TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–ï ===
        TELEGRAM_BOT_TOKEN="8364800671:AAE7YazwQE0oEJ6RyGhwg30ZDqF9967L9tk"
        TELEGRAM_CHAT_ID="115815272"
        curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=üÜï –ë–∞–≥ $PADDED_ID: $2" >/dev/null
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $0 create \"–æ–ø–∏—Å–∞–Ω–∏–µ\""
        ;;
esac
